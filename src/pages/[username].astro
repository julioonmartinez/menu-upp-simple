---
// src/pages/[username].astro
import ProfileLayout from '../layouts/ProfileLayout.astro';
import ProfileHeader from '../components/ProfileHeader.astro';
import SocialLinks from '../components/SocialLinks.astro';
import LinkCard from '../components/LinkCard.astro';
import CTAButton from '../components/CTAButton.astro';

// Import services
import { fetchRestaurantProfile } from '../services/apiService';
import type { Restaurant, LinkTree, Link } from '../interfaces';
import BottomSheetQR from '../components/BottomSheetQR.astro';

interface Props {
  restaurant: Restaurant;
  linkTree: LinkTree;
}

const { username } = Astro.params;

let restaurant: Restaurant;
let linkTree: LinkTree;

// Verificar si el username existe
if (!username) {
  return Astro.redirect('/404');
}

try {
  const result = await fetchRestaurantProfile(username);
  restaurant = result.restaurant;
  linkTree = result.linkTree;
} catch (error) {
  // Si no encuentra el perfil, redirigir a 404
  return Astro.redirect('/404');
}

// Verificaciones de seguridad
if (!restaurant || !linkTree) {
  return Astro.redirect('/404');
}

// Verificar que el perfil estÃ© pÃºblico
if (!linkTree.isPublic) {
  return Astro.redirect('/404');
}

// Filtrar y ordenar links activos
const activeLinks = linkTree.links
  ?.filter((link: Link) => link.active)
  ?.sort((a: Link, b: Link) => a.order - b.order) || [];

// Configurar tema para componentes
const socialTheme = {
  backgroundColor: linkTree.socialMediaBackgroundColor || restaurant.primaryColor,
  textColor: linkTree.socialMediaTextColor
};

const linkTheme = {
  backgroundColor: linkTree.linksBackgroundColor,
  textColor: linkTree.linksColor
};

const ctaTheme = {
  backgroundColor: linkTree.ctaBackgroundColor || restaurant.primaryColor,
  textColor: linkTree.ctaTextColor
};
---

<ProfileLayout restaurant={restaurant} linkTree={linkTree}>
  <main class="profile-content">
    <!-- Header con imagen, perfil, nombre y ubicaciÃ³n -->
    <ProfileHeader restaurant={restaurant} linkTree={linkTree} />
    
    <!-- Redes sociales -->
    <SocialLinks socialLinks={restaurant.socialLinks} theme={socialTheme} />
    
    <!-- Enlaces principales -->
    {activeLinks.length > 0 && (
      <div class="main-links">
        {activeLinks.map((link: Link) => (
          <LinkCard username={username} link={link} theme={linkTheme} />
        ))}
      </div>
    )}
    
    <!-- Call to Action -->
    <!-- <CTAButton restaurant={restaurant} theme={ctaTheme} /> -->
    
    <!-- InformaciÃ³n adicional -->
    {(restaurant.cuisineType || restaurant.features) && (
      <div class="additional-info">
        {restaurant.cuisineType && restaurant.cuisineType.length > 0 && (
          <div class="info-section">
            <h3 class="info-title">Tipo de cocina</h3>
            <div class="info-tags">
              {restaurant.cuisineType.map(cuisine => (
                <span class="info-tag">{cuisine}</span>
              ))}
            </div>
          </div>
        )}
        
        {restaurant.features && restaurant.features.length > 0 && (
          <div class="info-section">
            <h3 class="info-title">Servicios</h3>
            <div class="info-tags">
              {restaurant.features.map(feature => (
                <span class="info-tag">
                  {feature === 'delivery' ? 'ðŸšš Domicilio' :
                   feature === 'takeaway' ? 'ðŸ¥¡ Para llevar' :
                   feature === 'outdoor_seating' ? 'ðŸŒ¿ Terraza' :
                   feature}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>
    )}
  </main>
</ProfileLayout>

<style>
  .profile-content {
    padding: 0 0 2rem 0;
    min-height: 90vh;
  }
  
  .main-links {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0 1.5rem;
    margin-bottom: 1rem;
  }
  
  .additional-info {
    padding: 0 1.5rem;
    margin-top: 2rem;
  }
  
  .info-section {
    margin-bottom: 1.5rem;
  }
  
  .info-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.75rem;
    opacity: 0.8;
  }
  
  .info-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .info-tag {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
    color: var(--primary-color);
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid color-mix(in srgb, var(--primary-color) 20%, transparent);
  }
  
  /* Animaciones */
  .main-links > * {
    opacity: 0;
    transform: translateY(15px);
    animation: fadeInUp 0.6s ease forwards;
  }
  
  .main-links > *:nth-child(1) { animation-delay: 0.1s; }
  .main-links > *:nth-child(2) { animation-delay: 0.2s; }
  .main-links > *:nth-child(3) { animation-delay: 0.3s; }
  .main-links > *:nth-child(4) { animation-delay: 0.4s; }
  .main-links > *:nth-child(5) { animation-delay: 0.5s; }
  
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @media (max-width: 480px) {
    .main-links {
      padding: 0 1rem;
      gap: 0.5rem;
    }
    
    .additional-info {
      padding: 0 1rem;
    }
    
    .info-tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  }
</style>