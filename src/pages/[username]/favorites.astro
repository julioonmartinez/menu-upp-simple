---
// src/pages/[username]/favorites.astro
// Favoritos optimizado manteniendo la estructura simple original
import FavoritesDishes from '../../components/FavoritesDishes.svelte'
import type { LinkTree, Restaurant } from '../../interfaces';
import type { Category } from '../../interfaces/categories';
import type { Dish } from '../../interfaces/dish';
import Layout from '../../layouts/Layout.astro';
import { fetchLinksByUsername, fetchAllRestaurantDataByUsername } from '../../services/apiService';

const { username } = Astro.params;

if (!username) {
    return Astro.redirect('/404');
}

let restaurantInfo: Restaurant | null = null;
let categoriesInfo: Category[] | null = null;
let dishesInfo: Dish[] | null = null;
let errorMessage: string | null = null;
let linksTreeInfo: LinkTree | null = null;

try {
    // Optimización: fetch paralelo con Promise.all
    const [data, linksData] = await Promise.all([
        fetchAllRestaurantDataByUsername(username),
        fetchLinksByUsername(username)
    ]);
    
    restaurantInfo = data.restaurant;
    categoriesInfo = data.categories;
    dishesInfo = data.dishes;
    linksTreeInfo = linksData;

    // Verificar que el restaurante existe y está activo
    if (!restaurantInfo || !restaurantInfo.active) {
        return Astro.redirect('/404');
    }

    console.log('Datos obtenidos:', {
        restaurant: restaurantInfo,
        linksTree: linksTreeInfo,
        coloresRestaurante: {
            primary: restaurantInfo?.primaryColor,
            secondary: restaurantInfo?.secondaryColor
        }
    });
} catch (error) {
    console.error('Error al obtener datos:', error);
    errorMessage = error instanceof Error ? error.message : 'Error al cargar datos';
    dishesInfo = [];
    
    // Si es un 404, redirigir
    if (error instanceof Error && error.message.includes('404')) {
        return Astro.redirect('/404');
    }
}

// Validar y proveer valores por defecto para los colores
const primaryColor = restaurantInfo?.primaryColor || '#FF4500';
const secondaryColor = restaurantInfo?.secondaryColor || '#FF4500';
const backgroundColor = linksTreeInfo?.backgroundColor || '#FFFFFF';

// SEO optimizado para favoritos
const pageTitle = restaurantInfo 
    ? `Favoritos - ${restaurantInfo.name}`
    : 'Favoritos';

const pageDescription = restaurantInfo 
    ? `Tus platillos favoritos de ${restaurantInfo.name}`
    : 'Tus platillos favoritos';

const canonicalURL = new URL(`/${username}/favorites`, Astro.site);
const ogImage = restaurantInfo?.imageCover || restaurantInfo?.imageProfile;

console.log('Colores finales a pasar al componente:', {
    primaryColor,
    secondaryColor,
    backgroundColor
});
---

<Layout 
    restaurant={restaurantInfo!} 
    backgroundColor={backgroundColor}
    title={pageTitle}
    description={pageDescription}
    image={ogImage}
    canonicalURL={canonicalURL}
>
    <FavoritesDishes 
        username={restaurantInfo?.username} 
        transition:persist 
        primaryColor={primaryColor}
        secondaryColor={secondaryColor}
        backgroundColor={backgroundColor}
        client:load 
        dishes={dishesInfo}
    />
</Layout>