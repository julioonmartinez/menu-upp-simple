---
// src/pages/[username]/menu.astro
// Vista del men√∫ basada en username del restaurante
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import CategoryNav from '../../components/CategoryNav.astro';
import DynamicMenu from '../../components/DynamicMenu.svelte';
import HeroSlider from '../../components/HeroSlider.astro';
import FloatingButton from '../../components/microcomponentes/FloatingButton.svelte';
import { fetchAllRestaurantDataByUsername, fetchLinksByUsername } from '../../services/apiService';
import type { Restaurant } from '../../interfaces/restaurant';
import type { Category } from '../../interfaces/categories';
import type { Dish } from '../../interfaces/dish';
import type { LinkTree } from '../../interfaces';
import BottomSheetQR from '../../components/BottomSheetQR.astro';

// Obtener el username de los par√°metros de la URL
const { username } = Astro.params;

if (!username) {
  return Astro.redirect('/404');
}

// Estados iniciales
let restaurantInfo: Restaurant | null = null;
let categoriesInfo: Category[] | null = null;
let dishesInfo: Dish[] | null = null;
let errorMessage: string | null = null;
let linksTreeInfo: LinkTree | null = null;

try {
  // Obtener todos los datos del restaurante usando el username
  const data = await fetchAllRestaurantDataByUsername(username);
  linksTreeInfo = await fetchLinksByUsername(username);
  
  // Asignar los datos a las variables correspondientes
  restaurantInfo = data.restaurant;
  categoriesInfo = data.categories;
  dishesInfo = data.dishes;

  // Verificar que el restaurante existe y est√° activo
  if (!restaurantInfo) {
    return Astro.redirect('/404');
  }

  console.log('üè™ Restaurant Info:', restaurantInfo );
  console.log('üìÇ Categories count:', categoriesInfo?.length || 0);
  console.log('üçΩÔ∏è Total dishes count:', dishesInfo?.length || 0);
  
} catch (error) {
  console.error('‚ùå Error fetching restaurant data by username:', error);
  errorMessage = error instanceof Error ? error.message : 'Restaurant not found';
  
  // Si no se encuentra el restaurante, redirigir a 404
  if (error instanceof Error && error.message.includes('404')) {
    return Astro.redirect('/404');
  }
}

// Configurar slides del hero
const slides =  restaurantInfo?.heroSlides || [
  {
    imageUrl: restaurantInfo?.imageCover || '/images/restaurants/labellavita/cover.webp',
    title: `Bienvenidos a ${restaurantInfo?.name || 'nuestro restaurante'}`,
    subtitle: restaurantInfo?.description || 'Disfruta de la mejor comida tradicional'
  }
];

// Meta tags para SEO
const pageTitle = restaurantInfo ? `${restaurantInfo.name} - Men√∫ Completo` : 'Men√∫';
const pageDescription = restaurantInfo 
  ? `Descubre el delicioso men√∫ de ${restaurantInfo.name}. ${categoriesInfo?.length || 0} categor√≠as con ${dishesInfo?.length || 0} platillos √∫nicos.`
  : 'Men√∫ del restaurante';

// Verificar que tenemos los datos necesarios
const hasValidData = restaurantInfo && categoriesInfo && categoriesInfo.length > 0;
---

<Layout backgroundColor={linksTreeInfo?.backgroundColor || '#FFFF'} restaurant={restaurantInfo!} >
  <!-- Header del restaurante -->
  {hasValidData && (
    <Header restaurant={restaurantInfo!} linkTree={linksTreeInfo!} />
     <BottomSheetQR 
      restaurant={restaurantInfo!}
      linkTree={linksTreeInfo!}
    />
  )}
  
  <!-- Navegaci√≥n de categor√≠as -->
  {hasValidData && (
    <CategoryNav 
      categories={categoriesInfo!} 
      restaurant={restaurantInfo!} 
      linkTree={linksTreeInfo!} 
    />
  )}
  
  <!-- Hero Slider -->
  {hasValidData && (
    <HeroSlider 
      slides={slides}
      autoPlay={true}
      autoPlayInterval={5000}
      showDots={true}
      showArrows={true}
      height="35vh"
      primaryColor={restaurantInfo?.primaryColor}
      secondaryColor={restaurantInfo?.secondaryColor}
    />
  )}
  
  <!-- Contenedor del men√∫ con altura m√≠nima reservada -->
  {hasValidData ? (
    <div class="menu-container" id="menu-main-container">
      <!-- Skeleton loader inicial mientras el componente Svelte no est√© listo -->
      <div class="menu-skeleton" id="menu-skeleton">
        <div class="skeleton-header">
          <div class="skeleton-title"></div>
          <div class="skeleton-subtitle"></div>
        </div>
        <div class="skeleton-grid">
          {Array.from({length: 6}).map((_, i) => (
            <div class="skeleton-card" key={i}>
              <div class="skeleton-image"></div>
              <div class="skeleton-content">
                <div class="skeleton-line skeleton-line-title"></div>
                <div class="skeleton-line skeleton-line-subtitle"></div>
                <div class="skeleton-line skeleton-line-price"></div>
              </div>
            </div>
          ))}
        </div>
      </div>
      
      <!-- Componente Svelte que se carga cuando est√© listo -->
      <div class="dynamic-menu-wrapper" id="dynamic-menu-wrapper" style="display: none;">
        <DynamicMenu 
          username={username}
          categories={categoriesInfo!}
          restaurant={restaurantInfo!}
          storeMode={false}
          client:load
          primaryColor={restaurantInfo?.primaryColor}
          secondaryColor={restaurantInfo?.secondaryColor}
          backgroundColor={linksTreeInfo?.backgroundColor}
        />
      </div>
    </div>
  ) : (
    <div class="error-container">
      <div class="error-content">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h1 class="error-title">Error al cargar el men√∫</h1>
        <p class="error-description">
          {errorMessage || 'No se pudieron cargar los datos del restaurante'}
        </p>
        <a href={`/${username}`} class="back-button">
          Volver al perfil
        </a>
      </div>
    </div>
  )}
  
  <!-- Footer del men√∫ - Solo se muestra cuando el contenido est√° cargado -->
  <footer 
    class="menu-footer" 
    id="menu-footer"
    style={`--primary-color: ${restaurantInfo?.primaryColor}; --text-color:${linksTreeInfo?.textColor}; opacity: 0; transition: opacity 0.3s ease;`}
  >
    <div class="footer-content">
      <div class="restaurant-info">
        <h3>{restaurantInfo!.name}</h3>
        {restaurantInfo!.address && (
          <p class="address">üìç {restaurantInfo!.address}</p>
        )}
        {restaurantInfo!.phone && (
          <p class="phone">üìû {restaurantInfo!.phone}</p>
        )}
        {restaurantInfo!.schedule && (
          <p class="schedule">üïí {restaurantInfo!.schedule}</p>
        )}
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>¬© 2025 {restaurantInfo!.name} - Powered by Menu-upp</p>
    </div>
  </footer>
  
  <FloatingButton username={restaurantInfo?.username} client:load colorPrimary={restaurantInfo?.primaryColor || '#FF4500'}  ></FloatingButton>
   
</Layout>

<style>
  /* Contenedor principal del men√∫ */
  .menu-container {
    min-height: 100vh; /* Altura m√≠nima para reservar espacio */
    position: relative;
  }

  /* Skeleton loader mejorado */
  .menu-skeleton {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    animation: fadeIn 0.3s ease;
  }

  .skeleton-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .skeleton-title {
    height: 2rem;
    width: 300px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
    margin: 0 auto 1rem auto;
  }

  .skeleton-subtitle {
    height: 1rem;
    width: 200px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    margin: 0 auto;
    animation-delay: 0.2s;
  }

  .skeleton-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .skeleton-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    animation: fadeInUp 0.6s ease forwards;
  }

  .skeleton-card:nth-child(1) { animation-delay: 0.1s; }
  .skeleton-card:nth-child(2) { animation-delay: 0.2s; }
  .skeleton-card:nth-child(3) { animation-delay: 0.3s; }
  .skeleton-card:nth-child(4) { animation-delay: 0.4s; }
  .skeleton-card:nth-child(5) { animation-delay: 0.5s; }
  .skeleton-card:nth-child(6) { animation-delay: 0.6s; }

  .skeleton-image {
    height: 200px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  .skeleton-content {
    padding: 1.5rem;
  }

  .skeleton-line {
    height: 1rem;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    margin-bottom: 0.75rem;
  }

  .skeleton-line-title {
    width: 80%;
    height: 1.25rem;
  }

  .skeleton-line-subtitle {
    width: 100%;
    animation-delay: 0.2s;
  }

  .skeleton-line-price {
    width: 40%;
    animation-delay: 0.4s;
  }

  /* Wrapper del componente din√°mico */
  .dynamic-menu-wrapper {
    width: 100%;
  }

  /* Error container */
  .error-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 70vh;
    padding: 2rem;
  }
  
  .error-content {
    text-align: center;
    max-width: 500px;
    background: white;
    padding: 3rem 2rem;
    border-radius: 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  }
  
  .error-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
  }
  
  .error-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #dc2626;
    margin-bottom: 1rem;
  }
  
  .error-description {
    color: #6b7280;
    margin-bottom: 2rem;
    line-height: 1.6;
  }
  
  .back-button {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    border-radius: 50px;
    font-weight: 600;
    transition: transform 0.3s ease;
  }
  
  .back-button:hover {
    transform: translateY(-2px);
  }
  
  /* Footer del men√∫ */
  .menu-footer {
    background: var(--primary-color);
    margin-top: 3rem;
  }
  
  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 2rem;
    align-items: start;
  }
  
  .restaurant-info h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 1rem;
  }
  
  .restaurant-info p {
    color: var(--text-color);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }
  
  .footer-bottom {
    background: var(--primary-color);
    padding: 1rem;
    text-align: center;
  }
  
  .footer-bottom p {
    color: var(--text-color);
    font-size: 0.75rem;
    margin: 0;
  }
  
  /* Animaciones */
  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .skeleton-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    
    .footer-content {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      text-align: center;
    }
  }
  
  @media (max-width: 480px) {
    .menu-skeleton {
      padding: 1rem;
    }
    
    .skeleton-grid {
      gap: 1rem;
    }
    
    .error-content {
      padding: 2rem 1rem;
    }
    
    .footer-content {
      padding: 1.5rem 1rem;
    }
    
    .error-title {
      font-size: 1.5rem;
    }
  }
</style>

<script>
  // Analytics y tracking
  document.addEventListener('DOMContentLoaded', () => {
    // Track page view
    window.dispatchEvent(new CustomEvent('menuPageView', {
      detail: {
        restaurantUsername: window.location.pathname.split('/')[1],
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        referrer: document.referrer
      }
    }));
    
    // Manejar la transici√≥n del skeleton al contenido real
    let svelteComponentReady = false;
    
    // Escuchar cuando el componente Svelte est√© completamente montado
    document.addEventListener('svelteMenuReady', () => {
      svelteComponentReady = true;
      handleMenuTransition();
    });
    
    // Tambi√©n verificar peri√≥dicamente si el componente ya se renderiz√≥
    const checkInterval = setInterval(() => {
      const dynamicMenuContent = document.querySelector('#menu-section');
      if (dynamicMenuContent && dynamicMenuContent.children.length > 0) {
        svelteComponentReady = true;
        handleMenuTransition();
        clearInterval(checkInterval);
      }
    }, 100);
    
    // Limpiar el intervalo despu√©s de 10 segundos m√°ximo
    setTimeout(() => {
      clearInterval(checkInterval);
      if (!svelteComponentReady) {
        // Si por alguna raz√≥n no se detect√≥ la carga, mostrar de todos modos
        handleMenuTransition();
      }
    }, 10000);
    
    function handleMenuTransition() {
      const skeleton = document.getElementById('menu-skeleton');
      const dynamicWrapper = document.getElementById('dynamic-menu-wrapper');
      const footer = document.getElementById('menu-footer');
      
      if (skeleton && dynamicWrapper) {
        // Fade out skeleton
        skeleton.style.transition = 'opacity 0.3s ease';
        skeleton.style.opacity = '0';
        
        setTimeout(() => {
          // Hide skeleton and show dynamic menu
          skeleton.style.display = 'none';
          dynamicWrapper.style.display = 'block';
          dynamicWrapper.style.opacity = '0';
          dynamicWrapper.style.transition = 'opacity 0.3s ease';
          
          // Fade in dynamic menu
          setTimeout(() => {
            dynamicWrapper.style.opacity = '1';
            
            // Show footer
            if (footer) {
              footer.style.opacity = '1';
            }
          }, 50);
        }, 300);
      }
    }
    
    console.log('üçΩÔ∏è Menu page loaded successfully');
  });

  // Manejo del sticky category nav
  document.addEventListener('DOMContentLoaded', () => {
    const categoryNav = document.querySelector('.category-nav');
    if (!categoryNav) return;
    
    const navTop = categoryNav.offsetTop;
    
    window.addEventListener('scroll', () => {
      if (window.scrollY >= navTop) {
        categoryNav.style.position = 'fixed';
        categoryNav.style.top = '0px';
        categoryNav.style.left = '0';
        categoryNav.style.right = '0';
        categoryNav.style.zIndex = '100';
        categoryNav.style.width = '100%';
      } else {
        categoryNav.style.position = 'static';
        categoryNav.style.top = '';
        categoryNav.style.left = '';
        categoryNav.style.right = '';
        categoryNav.style.width = '';
      }
    });
  });
</script>