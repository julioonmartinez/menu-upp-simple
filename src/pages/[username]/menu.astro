---
// src/pages/[username]/menu.astro
// Vista del menú basada en username del restaurante
import Layout from '../../layouts/Layout.astro';
import Hero from '../../components/Hero.astro';
import CategoryNav from '../../components/CategoryNav.astro';
import Header from '../../components/Header.astro';
import FloatingButton from '../../components/microcomponentes/FloatingButton.svelte';
import MenuSection from '../../components/MenuSection.astro';
import PromotionModal from '../../components/PromotionModal.svelte';
// import AnalyticsTracker from '../../components/AnalyticsTracker.astro';
import { fetchAllRestaurantDataByUsername, fetchDishesByUsernameAndCategory } from '../../services/apiService';
import type { Restaurant } from '../../interfaces/restaurant';
import type { Category } from '../../interfaces/categories';
import type { Dish } from '../../interfaces/dish';
import { fetchLinksByUsername } from '../../services/apiService';
import type { LinkTree } from '../../interfaces';
import HeroSlider from '../../components/HeroSlider.astro';

// Obtener el username de los parámetros de la URL
const { username } = Astro.params;

if (!username) {
  return Astro.redirect('/404');
  
}

// Estados iniciales
let restaurantInfo: Restaurant | null = null;
let categoriesInfo: Category[] | null = null;
let dishesInfo: Dish[] | null = null;
let errorMessage: string | null = null;
let linksTreeInfo : LinkTree | null = null

try {
  // Obtener todos los datos del restaurante usando el username
  const data = await fetchAllRestaurantDataByUsername(username);
  linksTreeInfo = await fetchLinksByUsername(username)
  // Asignar los datos a las variables correspondientes
  restaurantInfo = data.restaurant;
  categoriesInfo = data.categories;
  dishesInfo = data.dishes;

  // Verificar que el restaurante existe y está activo
  if (!restaurantInfo) {
    return Astro.redirect('/404');
  }

  // console.log('Restaurant Info:', restaurantInfo.name);
  // console.log('Categories count:', categoriesInfo?.length || 0);
  // console.log('Dishes count:', dishesInfo?.length || 0);
  const dishesByCategory = await fetchDishesByUsernameAndCategory(username, categoriesInfo[0].id!);
  console.log(linksTreeInfo)
  // console.log( 'dishes by category 0', dishesByCategory)
  
} catch (error) {
  console.error('Error fetching restaurant data by username:', error);
  errorMessage = error instanceof Error ? error.message : 'Restaurant not found';
  
  // Si no se encuentra el restaurante, redirigir a 404
  if (error instanceof Error && error.message.includes('404')) {
    return Astro.redirect('/404');
  }
}
const slides = [
  {
    imageUrl: '/images/restaurants/labellavita/cover.webp',
    title: 'Bienvenidos a nuestro restaurante',
    subtitle: 'Disfruta de la mejor comida mexicana tradicional'
  },
  {
    imageUrl: '/images/restaurants/sushizen/cover.webp', 
    title: 'Platillos únicos',
    subtitle: 'Preparados con ingredientes frescos y locales'
  },
  {
    imageUrl: '/images/restaurants/tacoselrey/cover.webp',
    title: 'Ambiente familiar',
    subtitle: 'El lugar perfecto para compartir momentos especiales'
  }
];

// Meta tags para SEO
const pageTitle = restaurantInfo ? `${restaurantInfo.name} - Menú Completo` : 'Menú';
const pageDescription = restaurantInfo 
  ? `Descubre el delicioso menú de ${restaurantInfo.name}. ${categoriesInfo?.length || 0} categorías con ${dishesInfo?.length || 0} platillos únicos.`
  : 'Menú del restaurante';
---
<Layout>
<Header restaurant={restaurantInfo!} linkTree={linksTreeInfo!} ></Header>
<CategoryNav categories={categoriesInfo!} restaurant={restaurantInfo!} linkTree={linksTreeInfo!} ></CategoryNav>
<HeroSlider slides={slides} slides={slides}
  autoPlay={true}
  autoPlayInterval={5000}
  showDots={true}
  showArrows={true}
  height="40vh"
  primaryColor={restaurantInfo?.primaryColor}
  secondaryColor={restaurantInfo?.secondaryColor}


></HeroSlider>
  <Layout />

