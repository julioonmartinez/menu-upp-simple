---
import Layout from '../../layouts/Layout.astro';
import type { RestaurantSearchResponse } from '../../interfaces/restaurantRating';
import HomeLayout from '../../layouts/HomeLayout.astro';

// Esta p√°gina manejar√° la b√∫squeda avanzada de restaurantes
let searchResults: RestaurantSearchResponse | null = null;
let error: string | null = null;

// Si hay par√°metros de b√∫squeda, ejecutar b√∫squeda en el servidor
const url = Astro.url;
const searchParams = url.searchParams;

if (searchParams.has('search') || searchParams.has('minRating')) {
  try {
    // Importar din√°micamente para evitar errores en build
    const { searchRestaurants } = await import('../../services/apiRatingService');
    
    const filters = {
      search: searchParams.get('search') || undefined,
      minRating: searchParams.get('minRating') ? parseFloat(searchParams.get('minRating')!) : undefined,
      maxRating: searchParams.get('maxRating') ? parseFloat(searchParams.get('maxRating')!) : undefined,
      cuisineType: searchParams.get('cuisineType') || undefined,
      priceRange: searchParams.get('priceRange') || undefined,
      sortBy: searchParams.get('sortBy') || 'rating',
      sortOrder: searchParams.get('sortOrder') ? parseInt(searchParams.get('sortOrder')!) : -1,
    };

    const page = parseInt(searchParams.get('page') || '1');
    searchResults = await searchRestaurants(filters, page, 20);
  } catch (e) {
    error = e instanceof Error ? e.message : 'Error en la b√∫squeda';
    console.error('Error en b√∫squeda SSR:', e);
  }
}
---

<HomeLayout>
  <main class="search-page">
    <div class="container">
      <h1>Buscar Restaurantes</h1>
      
      <!-- Formulario de b√∫squeda -->
      <form class="search-form" id="searchForm">
        <div class="search-row">
          <input 
            type="text" 
            name="search" 
            placeholder="Buscar por nombre, tipo de cocina..."
            value={searchParams.get('search') || ''}
          />
          <button type="submit">Buscar</button>
        </div>
        
        <div class="filters-row">
          <div class="filter-group">
            <label>Valoraci√≥n m√≠nima:</label>
            <select name="minRating">
              <option value="">Cualquiera</option>
              <option value="4.5" selected={searchParams.get('minRating') === '4.5'}>4.5+ ‚≠ê</option>
              <option value="4.0" selected={searchParams.get('minRating') === '4.0'}>4.0+ ‚≠ê</option>
              <option value="3.5" selected={searchParams.get('minRating') === '3.5'}>3.5+ ‚≠ê</option>
              <option value="3.0" selected={searchParams.get('minRating') === '3.0'}>3.0+ ‚≠ê</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Tipo de cocina:</label>
            <select name="cuisineType">
              <option value="">Todos</option>
              <option value="mexicana" selected={searchParams.get('cuisineType') === 'mexicana'}>Mexicana</option>
              <option value="italiana" selected={searchParams.get('cuisineType') === 'italiana'}>Italiana</option>
              <option value="asi√°tica" selected={searchParams.get('cuisineType') === 'asi√°tica'}>Asi√°tica</option>
              <option value="americana" selected={searchParams.get('cuisineType') === 'americana'}>Americana</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Rango de precios:</label>
            <select name="priceRange">
              <option value="">Cualquiera</option>
              <option value="low" selected={searchParams.get('priceRange') === 'low'}>Econ√≥mico ($)</option>
              <option value="medium" selected={searchParams.get('priceRange') === 'medium'}>Medio ($$)</option>
              <option value="high" selected={searchParams.get('priceRange') === 'high'}>Alto ($$$)</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Ordenar por:</label>
            <select name="sortBy">
              <option value="rating" selected={searchParams.get('sortBy') === 'rating'}>Valoraci√≥n</option>
              <option value="name" selected={searchParams.get('sortBy') === 'name'}>Nombre</option>
              <option value="analytics.reviewsCount" selected={searchParams.get('sortBy') === 'analytics.reviewsCount'}>M√°s rese√±as</option>
            </select>
          </div>
        </div>
      </form>

      <!-- CONTENEDOR PRINCIPAL DE RESULTADOS - SIEMPRE PRESENTE -->
      <div id="searchResultsContainer">
        <!-- Mensaje de error -->
        {error && (
          <div class="error-message">
            <p>Error: {error}</p>
          </div>
        )}

        <!-- Resultados de b√∫squeda del servidor -->
        {searchResults && (
          <div class="search-results">
            <div class="results-header">
              <h2>Resultados ({searchResults.pagination.total} restaurantes)</h2>
              <p>P√°gina {searchResults.pagination.page} de {searchResults.pagination.total_pages}</p>
            </div>
            
            <div class="restaurants-grid" id="resultsContainer">
              {searchResults.restaurants.map(restaurant => (
                <div class="restaurant-card">
                  <div class="restaurant-image">
                    {(restaurant.image || restaurant.imageProfile) ? (
                      <img 
                        src={restaurant.image || restaurant.imageProfile} 
                        alt={restaurant.name}
                        loading="lazy"
                      />
                    ) : (
                      <div class="restaurant-icon-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M8.1 13.34L7.2 14.24C6.45 14.99 6.45 16.22 7.2 16.97C7.95 17.72 9.18 17.72 9.93 16.97L10.83 16.07C11.58 15.32 11.58 14.09 10.83 13.34C10.08 12.59 8.85 12.59 8.1 13.34ZM14.24 7.2C14.99 6.45 16.22 6.45 16.97 7.2C17.72 7.95 17.72 9.18 16.97 9.93L16.07 10.83C15.32 11.58 14.09 11.58 13.34 10.83C12.59 10.08 12.59 8.85 13.34 8.1L14.24 7.2ZM12.94 14.06L9.94 11.06L11.06 9.94L14.06 12.94L12.94 14.06Z" fill="white"/>
                          <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 3V4H9V3L3 7V9H21ZM21 10H3V21C3 21.6 3.4 22 4 22H20C20.6 22 21 21.6 21 21V10Z" fill="white"/>
                        </svg>
                      </div>
                    )}
                  </div>
                  <div class="restaurant-info">
                    <h3>
                      <a href={`/${restaurant.username}`}>{restaurant.name}</a>
                    </h3>
                    <p class="description">{restaurant.description}</p>
                    
                    <div class="restaurant-meta">
                      <div class="rating">
                        <span class="stars">
                          {[1,2,3,4,5].map(star => (
                            <span class={`star ${star <= (restaurant.analytics?.averageRating || 0) ? 'filled' : ''}`}>‚≠ê</span>
                          ))}
                        </span>
                        <span class="rating-value">{restaurant.analytics?.averageRating?.toFixed(1) || 'N/A'}</span>
                        <span class="reviews-count">({restaurant.analytics?.reviewsCount || 0} rese√±as)</span>
                      </div>
                      
                      <div class="restaurant-details">
                        {restaurant.cuisineType && (
                          <span class="cuisine-badge">{restaurant.cuisineType[0]}</span>
                        )}
                        {restaurant.priceRange && (
                          <span class="price-badge">
                            {restaurant.priceRange === 'low' && '$'}
                            {restaurant.priceRange === 'medium' && '$$'}
                            {restaurant.priceRange === 'high' && '$$$'}
                          </span>
                        )}
                        {restaurant.address && (
                          <span class="address">{restaurant.address}</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

          
            {searchResults.pagination.total_pages > 1 && (
              <div class="pagination">
                {searchResults.pagination.has_prev && (
                  <a href={`?${new URLSearchParams({...Object.fromEntries(searchParams.entries()), page: (searchResults.pagination.page - 1).toString()})}`} 
                     class="pagination-btn">
                    ‚Üê Anterior
                  </a>
                )}
                
                <span class="page-info">
                  P√°gina {searchResults.pagination.page} de {searchResults.pagination.total_pages}
                </span>
                
                {searchResults.pagination.has_next && (
                  <a href={`?${new URLSearchParams({...Object.fromEntries(searchParams.entries()), page: (searchResults.pagination.page + 1).toString()})}`}
                     class="pagination-btn">
                    Siguiente ‚Üí
                  </a>
                )}
              </div>
            )}
          </div>
        )}

        <!-- Estado vac√≠o inicial -->
        {!searchResults && !error && (
          <div class="empty-state">
            <p>Usa el formulario arriba para buscar restaurantes por nombre, valoraci√≥n, tipo de cocina y m√°s.</p>
          </div>
        )}
      </div>
    </div>
  </main>
</Layout>

<script>
  import { searchRestaurants } from '../../services/apiRatingService';

  // Manejar b√∫squeda con JavaScript para mejor UX
  const searchForm = document.getElementById('searchForm') as HTMLFormElement;
  const searchResultsContainer = document.getElementById('searchResultsContainer');

  if (searchForm && searchResultsContainer) {
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(searchForm);
      const filters = {
        search: formData.get('search')?.toString(),
        minRating: formData.get('minRating') ? parseFloat(formData.get('minRating')!.toString()) : undefined,
        cuisineType: formData.get('cuisineType')?.toString(),
        priceRange: formData.get('priceRange')?.toString(),
        sortBy: formData.get('sortBy')?.toString() || 'rating',
        sortOrder: -1
      };

      // Filtrar valores vac√≠os
      Object.keys(filters).forEach(key => {
        if (!filters[key as keyof typeof filters]) {
          delete filters[key as keyof typeof filters];
        }
      });

      try {
        showLoading();
        const results = await searchRestaurants(filters, 1, 20);
        console.log('üîç Resultados obtenidos:', results); // Debug
        displayResults(results);
        
        // Actualizar URL sin recargar p√°gina
        const searchParams = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
          if (value !== undefined) {
            searchParams.set(key, value.toString());
          }
        });
        window.history.pushState({}, '', `${window.location.pathname}?${searchParams}`);
        
      } catch (error) {
        console.error('Error en b√∫squeda:', error);
        showError('Error al buscar restaurantes. Int√©ntalo de nuevo.');
      }
    });
  }

  function showLoading() {
    if (searchResultsContainer) {
      searchResultsContainer.innerHTML = '<div class="loading">Buscando restaurantes...</div>';
    }
  }

  function showError(message: string) {
    if (searchResultsContainer) {
      searchResultsContainer.innerHTML = `<div class="error">${message}</div>`;
    }
  }

  function displayResults(results: any) {
    if (!searchResultsContainer) {
      console.error('‚ùå searchResultsContainer no encontrado');
      return;
    }

    console.log('üìä Mostrando resultados:', results.restaurants.length, 'restaurantes'); // Debug

    if (results.restaurants.length === 0) {
      searchResultsContainer.innerHTML = '<div class="no-results">No se encontraron restaurantes con esos criterios.</div>';
      return;
    }

    // Crear el HTML completo de los resultados
    const resultsHTML = `
      <div class="search-results">
        <div class="results-header">
          <h2>Resultados (${results.pagination.total} restaurantes)</h2>
          <p>P√°gina ${results.pagination.page} de ${results.pagination.total_pages}</p>
        </div>
        
        <div class="restaurants-grid">
          ${results.restaurants.map((restaurant: any) => `
            <div class="restaurant-card">
              <div class="restaurant-image">
                ${restaurant.image || restaurant.imageProfile ? 
                  `<img src="${restaurant.image || restaurant.imageProfile}" 
                       alt="${restaurant.name}" loading="lazy" />` :
                  `<div class="restaurant-icon-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8.1 13.34L7.2 14.24C6.45 14.99 6.45 16.22 7.2 16.97C7.95 17.72 9.18 17.72 9.93 16.97L10.83 16.07C11.58 15.32 11.58 14.09 10.83 13.34C10.08 12.59 8.85 12.59 8.1 13.34ZM14.24 7.2C14.99 6.45 16.22 6.45 16.97 7.2C17.72 7.95 17.72 9.18 16.97 9.93L16.07 10.83C15.32 11.58 14.09 11.58 13.34 10.83C12.59 10.08 12.59 8.85 13.34 8.1L14.24 7.2ZM12.94 14.06L9.94 11.06L11.06 9.94L14.06 12.94L12.94 14.06Z" fill="white"/>
                      <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 3V4H9V3L3 7V9H21ZM21 10H3V21C3 21.6 3.4 22 4 22H20C20.6 22 21 21.6 21 21V10Z" fill="white"/>
                    </svg>
                  </div>`
                }
              </div>
              <div class="restaurant-info">
                <h3><a href="/${restaurant.username}">${restaurant.name}</a></h3>
                <p class="description">${restaurant.description || ''}</p>
                <div class="restaurant-meta">
                  <div class="rating">
                    <span class="stars">
                      ${[1,2,3,4,5].map(star => 
                        `<span class="star ${star <= (restaurant.analytics?.averageRating || 0) ? 'filled' : ''}">‚≠ê</span>`
                      ).join('')}
                    </span>
                    <span class="rating-value">${restaurant.analytics?.averageRating?.toFixed(1) || 'N/A'}</span>
                    <span class="reviews-count">(${restaurant.analytics?.reviewsCount || 0} rese√±as)</span>
                  </div>
                  <div class="restaurant-details">
                    ${restaurant.cuisineType?.[0] ? `<span class="cuisine-badge">${restaurant.cuisineType[0]}</span>` : ''}
                    ${restaurant.priceRange ? `<span class="price-badge">${
                      restaurant.priceRange === 'low' ? '$' : 
                      restaurant.priceRange === 'medium' ? '$$' : '$$$'
                    }</span>` : ''}
                    ${restaurant.address ? `<span class="address">${restaurant.address}</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>

        ${results.pagination.total_pages > 1 ? `
          <div class="pagination">
            ${results.pagination.has_prev ? `
              <button class="pagination-btn" onclick="loadPage(${results.pagination.page - 1})">
                ‚Üê Anterior
              </button>
            ` : ''}
            
            <span class="page-info">
              P√°gina ${results.pagination.page} de ${results.pagination.total_pages}
            </span>
            
            ${results.pagination.has_next ? `
              <button class="pagination-btn" onclick="loadPage(${results.pagination.page + 1})">
                Siguiente ‚Üí
              </button>
            ` : ''}
          </div>
        ` : ''}
      </div>
    `;

    searchResultsContainer.innerHTML = resultsHTML;
    console.log('‚úÖ Resultados mostrados en la UI'); // Debug
  }

  // Funci√≥n global para paginaci√≥n
  (window as any).loadPage = async (page: number) => {
    const formData = new FormData(searchForm);
    const filters = {
      search: formData.get('search')?.toString(),
      minRating: formData.get('minRating') ? parseFloat(formData.get('minRating')!.toString()) : undefined,
      cuisineType: formData.get('cuisineType')?.toString(),
      priceRange: formData.get('priceRange')?.toString(),
      sortBy: formData.get('sortBy')?.toString() || 'rating',
      sortOrder: -1
    };

    // Filtrar valores vac√≠os
    Object.keys(filters).forEach(key => {
      if (!filters[key as keyof typeof filters]) {
        delete filters[key as keyof typeof filters];
      }
    });

    try {
      showLoading();
      const results = await searchRestaurants(filters, page, 20);
      displayResults(results);
      
      // Actualizar URL
      const searchParams = new URLSearchParams();
      Object.entries(filters).forEach(([key, value]) => {
        if (value !== undefined) {
          searchParams.set(key, value.toString());
        }
      });
      searchParams.set('page', page.toString());
      window.history.pushState({}, '', `${window.location.pathname}?${searchParams}`);
      
    } catch (error) {
      console.error('Error en paginaci√≥n:', error);
      showError('Error al cargar la p√°gina. Int√©ntalo de nuevo.');
    }
  };
</script>

<style>
  .search-page {
    padding: 20px 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .search-form {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }

  .search-row {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  .search-row input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
  }

  .search-row button {
    padding: 12px 24px;
    background: #ff6b35;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }

  .filters-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .filter-group label {
    font-weight: bold;
    font-size: 14px;
    color: #555;
  }

  .filter-group select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .restaurants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }

  .restaurant-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
  }

  .restaurant-card:hover {
    transform: translateY(-5px);
  }

  .restaurant-image img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .restaurant-icon-placeholder {
    width: 100%;
    height: 200px;
    background: #e5e5e5;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid #e9ecef;
  }

  .restaurant-icon-placeholder svg {
    opacity: 0.6;
  }

  .restaurant-info {
    padding: 15px;
  }

  .restaurant-info h3 {
    margin: 0 0 10px 0;
  }

  .restaurant-info h3 a {
    color: #333;
    text-decoration: none;
  }

  .restaurant-info h3 a:hover {
    color: #ff6b35;
  }

  .description {
    color: #666;
    font-size: 14px;
    margin-bottom: 15px;
  }

  .rating {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .star {
    color: #ddd;
  }

  .star.filled {
    color: #ffc107;
  }

  .restaurant-details {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .cuisine-badge,
  .price-badge {
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }

  .address {
    color: #666;
    font-size: 12px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 40px;
  }

  .pagination-btn {
    padding: 10px 20px;
    background: #ff6b35;
    color: white;
    text-decoration: none;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
  }

  .pagination-btn:hover {
    background: #e55a2b;
  }

  .loading,
  .error,
  .no-results {
    text-align: center;
    padding: 40px;
    color: #666;
  }

  .error {
    color: #dc3545;
  }

  .error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .results-header h2 {
    margin: 0;
  }

  .results-header p {
    margin: 0;
    color: #666;
  }
</style>