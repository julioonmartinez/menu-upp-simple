---
// components/EnhancedCategoryNav.astro
import type { Category } from "../interface/categories";

interface Props {
  CATEGORIES: Category[];
  activeCategory?: string;
}

const { CATEGORIES, activeCategory } = Astro.props as Props;

// Generar ID √∫nico para los iconos de categor√≠as
const generateCategoryIcon = (categoryName: string) => {
  const name = categoryName.toLowerCase();
  if (name.includes('entrada') || name.includes('aperitivo')) return 'ü•ó';
  if (name.includes('plato fuerte') || name.includes('principal')) return 'üçΩÔ∏è';
  if (name.includes('postre') || name.includes('dulce')) return 'üç∞';
  if (name.includes('bebida') || name.includes('drink')) return 'ü•§';
  if (name.includes('pizza')) return 'üçï';
  if (name.includes('burger') || name.includes('hamburguesa')) return 'üçî';
  if (name.includes('pasta') || name.includes('spaghetti')) return 'üçù';
  if (name.includes('sushi') || name.includes('japon√©s')) return 'üç£';
  if (name.includes('taco') || name.includes('mexicano')) return 'üåÆ';
  if (name.includes('ensalada') || name.includes('salad')) return 'ü•¨';
  if (name.includes('sopa') || name.includes('soup')) return 'üç≤';
  if (name.includes('cafe') || name.includes('coffee')) return '‚òï';
  if (name.includes('helado') || name.includes('ice cream')) return 'üç¶';
  return 'üçΩÔ∏è'; // Default icon
};
---

<nav class="category-navigation" data-categories-nav>
  <div class="nav-container">
    <!-- Mobile Scroll Hint -->
    <div class="scroll-hint mobile-only">
      <span class="hint-text">Desliza para ver m√°s ‚Üí</span>
    </div>
    
    <!-- Categories List -->
    <div class="categories-wrapper">
      <div class="categories-list" id="categories-list">
        {CATEGORIES && CATEGORIES.map((category, index) => (
          <a 
            href={`#category-${category.id}`}
            class="category-item"
            data-category-id={category.id}
            data-category-name={category.name}
            data-index={index}
            style={`--delay: ${index * 0.1}s`}
          >
            <div class="category-content">
              <div class="category-icon">
                {generateCategoryIcon(category.name)}
              </div>
              <div class="category-info">
                <span class="category-name">{category.name}</span>
                <span class="category-count">{category.dishCount || 0} platillos</span>
              </div>
              <div class="category-indicator"></div>
            </div>
            <div class="ripple-effect"></div>
          </a>
        ))}
      </div>
    </div>
    
    <!-- Navigation Controls -->
    <div class="nav-controls desktop-only">
      <button class="nav-btn prev-btn" id="prev-btn" aria-label="Categor√≠a anterior">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button class="nav-btn next-btn" id="next-btn" aria-label="Siguiente categor√≠a">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
    
    <!-- Active Category Indicator -->
    <div class="active-indicator" id="active-indicator"></div>
  </div>
</nav>

<script>
  // Enhanced Category Navigation Script
  class CategoryNavigation {
    constructor() {
      this.categoriesList = document.getElementById('categories-list');
      this.activeIndicator = document.getElementById('active-indicator');
      this.prevBtn = document.getElementById('prev-btn');
      this.nextBtn = document.getElementById('next-btn');
      this.categoryItems = document.querySelectorAll('.category-item');
      this.currentCategory = '';
      this.isScrolling = false;
      
      this.init();
    }
    
    init() {
      this.setupEventListeners();
      this.updateActiveCategory();
      this.setupIntersectionObserver();
      this.animateEntrance();
    }
    
    setupEventListeners() {
      // Category clicks
      this.categoryItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          this.handleCategoryClick(item);
        });
        
        // Ripple effect
        item.addEventListener('mousedown', (e) => {
          this.createRipple(e, item);
        });
      });
      
      // Navigation controls
      if (this.prevBtn) {
        this.prevBtn.addEventListener('click', () => this.scrollCategories('prev'));
      }
      
      if (this.nextBtn) {
        this.nextBtn.addEventListener('click', () => this.scrollCategories('next'));
      }
      
      // Scroll events
      this.categoriesList.addEventListener('scroll', () => {
        this.updateNavigationControls();
      });
      
      // Listen to category changes from menu
      document.addEventListener('categoryChange', (e) => {
        this.setActiveCategory(e.detail.category);
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') this.navigateCategory('prev');
        if (e.key === 'ArrowRight') this.navigateCategory('next');
      });
    }
    
    handleCategoryClick(item) {
      const categoryId = item.getAttribute('data-category-id');
      const categoryName = item.getAttribute('data-category-name');
      
      // Update active state
      this.setActiveCategory(categoryId);
      
      // Scroll to category section
      const targetSection = document.querySelector(`#category-${categoryId}`);
      if (targetSection) {
        targetSection.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }
      
      // Dispatch custom event
      document.dispatchEvent(new CustomEvent('categoryChange', {
        detail: { category: categoryId, categoryName }
      }));
      
      // Analytics tracking
      if (window.trackCategoryInteraction) {
        window.trackCategoryInteraction(categoryId);
      }
      
      // Custom event for external tracking
      window.dispatchEvent(new CustomEvent('categorySelected', {
        detail: {
          categoryId,
          categoryName,
          timestamp: Date.now(),
          source: 'navigation'
        }
      }));
    }
    
    setActiveCategory(categoryId) {
      // Remove active class from all items
      this.categoryItems.forEach(item => {
        item.classList.remove('active');
      });
      
      // Add active class to selected item
      const activeItem = document.querySelector(`[data-category-id="${categoryId}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
        this.currentCategory = categoryId;
        this.updateActiveIndicator(activeItem);
        this.scrollToActiveCategory(activeItem);
      }
    }
    
    updateActiveIndicator(activeItem) {
      if (!this.activeIndicator || !activeItem) return;
      
      const rect = activeItem.getBoundingClientRect();
      const containerRect = this.categoriesList.getBoundingClientRect();
      
      this.activeIndicator.style.transform = `translateX(${rect.left - containerRect.left}px)`;
      this.activeIndicator.style.width = `${rect.width}px`;
    }
    
    scrollToActiveCategory(activeItem) {
      if (!activeItem) return;
      
      const containerRect = this.categoriesList.getBoundingClientRect();
      const itemRect = activeItem.getBoundingClientRect();
      const scrollLeft = this.categoriesList.scrollLeft;
      
      const targetScroll = scrollLeft + itemRect.left - containerRect.left - (containerRect.width / 2) + (itemRect.width / 2);
      
      this.categoriesList.scrollTo({
        left: targetScroll,
        behavior: 'smooth'
      });
    }
    
    scrollCategories(direction) {
      const scrollAmount = 200;
      const currentScroll = this.categoriesList.scrollLeft;
      const targetScroll = direction === 'next' 
        ? currentScroll + scrollAmount 
        : currentScroll - scrollAmount;
      
      this.categoriesList.scrollTo({
        left: targetScroll,
        behavior: 'smooth'
      });
    }
    
    navigateCategory(direction) {
      const currentIndex = Array.from(this.categoryItems).findIndex(item => 
        item.getAttribute('data-category-id') === this.currentCategory
      );
      
      let targetIndex;
      if (direction === 'next') {
        targetIndex = (currentIndex + 1) % this.categoryItems.length;
      } else {
        targetIndex = currentIndex > 0 ? currentIndex - 1 : this.categoryItems.length - 1;
      }
      
      const targetItem = this.categoryItems[targetIndex];
      if (targetItem) {
        this.handleCategoryClick(targetItem);
      }
    }
    
    updateNavigationControls() {
      if (!this.prevBtn || !this.nextBtn) return;
      
      const isAtStart = this.categoriesList.scrollLeft <= 0;
      const isAtEnd = this.categoriesList.scrollLeft >= 
        this.categoriesList.scrollWidth - this.categoriesList.clientWidth;
      
      this.prevBtn.disabled = isAtStart;
      this.nextBtn.disabled = isAtEnd;
    }
    
    setupIntersectionObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const categoryId = entry.target.id.replace('category-', '');
            this.setActiveCategory(categoryId);
          }
        });
      }, {
        threshold: 0.3,
        rootMargin: '-100px 0px -50% 0px'
      });
      
      // Observe category sections
      document.querySelectorAll('[id^="category-"]').forEach(section => {
        observer.observe(section);
      });
    }
    
    updateActiveCategory() {
      // Set first category as active by default
      if (this.categoryItems.length > 0) {
        const firstCategory = this.categoryItems[0].getAttribute('data-category-id');
        this.setActiveCategory(firstCategory);
      }
    }
    
    createRipple(event, element) {
      const ripple = element.querySelector('.ripple-effect');
      const rect = element.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      const x = event.clientX - rect.left - size / 2;
      const y = event.clientY - rect.top - size / 2;
      
      ripple.style.width = ripple.style.height = size + 'px';
      ripple.style.left = x + 'px';
      ripple.style.top = y + 'px';
      
      ripple.classList.remove('animate');
      setTimeout(() => ripple.classList.add('animate'), 0);
    }
    
    animateEntrance() {
      this.categoryItems.forEach((item, index) => {
        setTimeout(() => {
          item.classList.add('animate-in');
        }, index * 100);
      });
    }
  }
  
  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new CategoryNavigation();
  });
</script>

<style>
  .category-navigation {
    position: relative;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(229, 231, 235, 0.5);
    z-index: 40;
  }
  
  .nav-container {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  .scroll-hint {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .categories-wrapper {
    position: relative;
    overflow: hidden;
  }
  
  .categories-list {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 1rem 0;
    gap: 0.5rem;
  }
  
  .categories-list::-webkit-scrollbar {
    display: none;
  }
  
  .category-item {
    position: relative;
    flex-shrink: 0;
    text-decoration: none;
    color: inherit;
    border-radius: 16px;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    opacity: 0;
    transform: translateY(20px);
    overflow: hidden;
    min-width: 160px;
  }
  
  .category-item.animate-in {
    opacity: 1;
    transform: translateY(0);
    transition-delay: var(--delay, 0s);
  }
  
  .category-content {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 1rem 1.25rem;
    background: white;
    border: 2px solid transparent;
    border-radius: 16px;
    transition: all 0.3s ease;
    z-index: 1;
  }
  
  .category-item:hover .category-content {
    background: #f8fafc;
    border-color: #e2e8f0;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
  
  .category-item.active .category-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
  }
  
  .category-icon {
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: #f1f5f9;
    border-radius: 12px;
    transition: all 0.3s ease;
  }
  
  .category-item.active .category-icon {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
  }
  
  .category-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .category-name {
    font-weight: 600;
    font-size: 0.875rem;
    line-height: 1.2;
  }
  
  .category-count {
    font-size: 0.75rem;
    opacity: 0.7;
    font-weight: 500;
  }
  
  .category-indicator {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 6px;
    background: currentColor;
    border-radius: 50%;
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .category-item.active .category-indicator {
    opacity: 1;
    transform: translateY(-50%) scale(1.5);
  }
  
  .ripple-effect {
    position: absolute;
    border-radius: 50%;
    background: rgba(102, 126, 234, 0.3);
    transform: scale(0);
    pointer-events: none;
    z-index: 0;
  }
  
  .ripple-effect.animate {
    animation: ripple 0.6s linear;
  }
  
  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }
  
  .nav-controls {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 8px;
    z-index: 2;
  }
  
  .nav-controls.desktop-only {
    right: 1rem;
  }
  
  .nav-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #64748b;
  }
  
  .nav-btn:hover:not(:disabled) {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #475569;
    transform: scale(1.05);
  }
  
  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .active-indicator {
    position: absolute;
    bottom: 0;
    height: 3px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 2px 2px 0 0;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 1;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .desktop-only {
      display: none;
    }
    
    .mobile-only {
      display: block;
    }
    
    .category-item {
      min-width: 140px;
    }
    
    .category-content {
      padding: 0.875rem 1rem;
    }
    
    .category-icon {
      width: 36px;
      height: 36px;
      font-size: 1.25rem;
    }
    
    .categories-list {
      padding: 0.75rem 0;
    }
  }
  
  @media (min-width: 769px) {
    .mobile-only {
      display: none;
    }
    
    .desktop-only {
      display: flex;
    }
  }
  
  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .category-navigation {
      background: rgba(31, 41, 55, 0.95);
      border-bottom-color: rgba(75, 85, 99, 0.5);
    }
    
    .category-content {
      background: #374151;
      color: #f9fafb;
    }
    
    .category-item:hover .category-content {
      background: #4b5563;
      border-color: #6b7280;
    }
    
    .category-icon {
      background: #4b5563;
    }
    
    .nav-btn {
      background: #374151;
      border-color: #4b5563;
      color: #9ca3af;
    }
    
    .nav-btn:hover:not(:disabled) {
      background: #4b5563;
      border-color: #6b7280;
      color: #d1d5db;
    }
  }
  
  /* Performance optimizations */
  .category-item,
  .category-content,
  .category-icon {
    will-change: transform, background-color, border-color;
  }
  
  /* Accessibility improvements */
  .category-item:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
  }
  
  .nav-btn:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
  }
  
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>