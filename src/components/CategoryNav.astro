---
import type { LinkTree, Restaurant } from '../interfaces';
import type { Category } from '../interfaces/categories'

interface Props {
    categories: Category[],
    restaurant : Restaurant,
    linkTree : LinkTree
}
const {categories, restaurant, linkTree} = Astro.props
const primaryColor = restaurant.primaryColor || '#1a202c';
const secondaryColor = restaurant.secondaryColor || '#e6ddd4';
const backgroundColor = linkTree.backgroundColor || '#FFFF';

const capitalizarPrimeraLetra = (str: string) => {
  return str.charAt(0).toUpperCase() + str.slice(1);
};
---
<nav class="category-nav" style={`--primary-color: ${primaryColor}; --secondary-color: ${secondaryColor}; --bg-color:${backgroundColor}`}>
  <div class="nav-container">
    <div class="nav-wrapper">
      <ul class="category-list">
        <div id="indicator" class="category-indicator"></div>
        {categories!.map((category, index) => (
          <li class="category-item">
            <button 
              class="category-button"
              data-category-id={category.id}
              data-category-name={category.name}
              data-index={index}
              aria-selected={index === 0 ? 'true' : 'false'}
            >
              {capitalizarPrimeraLetra(category.name)}
            </button>
          </li>
        ))}
      </ul>
    </div>
  </div>
</nav>

<script>
  class CategoryNavigation {
    navElement: HTMLElement | null;
    buttons: NodeListOf<HTMLButtonElement>;
    indicator: HTMLElement | null;
    currentCategory: { id: string; name: string; index: number } | null;
    constructor() {
      this.navElement = document.querySelector('.category-nav');
      this.buttons = document.querySelectorAll('.category-button');
      this.indicator = document.getElementById('indicator');
      this.currentCategory = null;
      
      this.init();
    }
    
    init() {
      // Configurar eventos de clic
      this.buttons.forEach((button: HTMLButtonElement) => {
        button.addEventListener('click', (e: Event) => {
          this.handleCategoryClick(e.target as HTMLButtonElement);
        });
      });
      
      // Activar la primera categoría por defecto
      if (this.buttons.length > 0) {
        this.setActiveCategory(this.buttons[0], false);
      }
      
      // Configurar indicador
      this.updateIndicator();
    }
    
    handleCategoryClick(button: HTMLButtonElement) {
      this.setActiveCategory(button, true);
    }
    
    setActiveCategory(button: HTMLButtonElement, shouldDispatch: boolean = true) {
      // Remover active de todos los botones
      this.buttons.forEach((btn: HTMLButtonElement) => {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
      });
      
      // Activar el botón seleccionado
      button.classList.add('active');
      button.setAttribute('aria-selected', 'true');
      
      // Obtener datos de la categoría
      const categoryId = button.getAttribute('data-category-id') ?? '';
      const categoryName = button.getAttribute('data-category-name') ?? '';
      const categoryIndex = parseInt(button.getAttribute('data-index') ?? '0');
      
      this.currentCategory = { id: categoryId, name: categoryName, index: categoryIndex };
      
      // Actualizar indicador
      this.updateIndicator();
      
      // Disparar evento personalizado si es necesario
      if (shouldDispatch) {
        this.dispatchCategoryChange(categoryId, categoryName, categoryIndex);
      }
      
      // Para la primera carga, también disparar el evento pero con un delay
      if (!shouldDispatch && categoryIndex === 0) {
        setTimeout(() => {
          this.dispatchCategoryChange(categoryId, categoryName, categoryIndex);
        }, 100);
      }
    }
    
    dispatchCategoryChange(categoryId: string, categoryName: string, categoryIndex: number) {
      // Crear evento personalizado
      const event = new CustomEvent('categoryChanged', {
        detail: {
          categoryId: categoryId ?? '',
          categoryName: categoryName ?? '',
          categoryIndex,
          timestamp: Date.now()
        },
        bubbles: true
      });
      
      // Disparar el evento
      document.dispatchEvent(event);
      
    }
    
    updateIndicator() {
  const activeButton = document.querySelector('.category-button.active') as HTMLElement;
  const categoryList = document.querySelector('.category-list') as HTMLElement;
  
  if (activeButton && this.indicator && categoryList) {
    const buttonRect = activeButton.getBoundingClientRect();
    const listRect = categoryList.getBoundingClientRect();
    
    // Calcular posición relativa al contenedor de la lista
    const left = buttonRect.left - listRect.left;
    const width = buttonRect.width;
    
    // Aplicar estilos al indicador
    this.indicator.style.left = `${left}px`;
    this.indicator.style.width = `${width}px`;
    this.indicator.style.opacity = '1';
  }
}
    
    // Método público para cambiar categoría programáticamente
    selectCategory(categoryId: string) {
      const button = document.querySelector(`[data-category-id="${categoryId}"]`) as HTMLButtonElement;
      if (button) {
        this.setActiveCategory(button, true);
      }
    }
    
    // Método para obtener la categoría actual
    getCurrentCategory() {
      return this.currentCategory;
    }
  }
  
  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', () => {
    new CategoryNavigation();
  });
  
  // Exponer globalmente para debugging
  (window as any).CategoryNavigation = CategoryNavigation;
</script>

<style>
  /* Navegación principal */
  .category-nav {
    background-color: white;
    padding: 0.75rem 0;
    position: sticky;
    top: 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    z-index: 30;
    height: fit-content;
    /* min-height: 60px; */

  }

  .nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .nav-wrapper {
    position: relative;
  }

  .category-list {
    display: flex;
    gap: 1.5rem;
    white-space: nowrap;
    padding: 0 0.5rem;
    position: relative;
    list-style: none;
    margin: 0;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .category-list::-webkit-scrollbar {
    display: none;
  }

  .category-item {
    flex-shrink: 0;
  }

  .category-button {
    font-size: 1.125rem;
    font-weight: 500;
    padding: 0.25rem 0;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    background: none;
    border: none;
    color: #6b7280;
    outline: none;
    text-transform: capitalize;
    /* min-height: 36px; */
  }

  .category-button:hover {
    color: var(--primary-color);
    transform: translateY(-1px);
  }

  .category-button:active {
    transform: translateY(0);
  }

  .category-button.active {
    color: var(--primary-color);
    font-weight: 600;
  }

  /* Indicador animado */
  .category-indicator {
    position: absolute;
    bottom: 0;
    height: 0.125rem;
    background-color: var(--primary-color);
    transition: all 0.3s ease;
    border-radius: 2px;
    width: 0;
    left: 0;
    opacity: 0;
  }

  /* Estados de focus para accesibilidad */
  .category-button:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
    border-radius: 4px;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .category-nav {
      /* padding: 0.5rem 0; */
    }
    
    .nav-container {
      padding: 0 0.75rem;
    }
    
    .category-list {
      gap: 1rem;
      padding: 0 0.25rem;
    }
    
    .category-button {
      /* font-size: 1rem;
      padding: 0.25rem 0.5rem; */
    }
  }

  @media (max-width: 480px) {
    .category-list {
      gap: 0.75rem;
    }
    
    .category-button {
      /* font-size: 0.875rem; */
    }
  }

  /* Animación suave para el scroll horizontal en móviles */
  @media (max-width: 768px) {
    .category-list {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
  }

  /* Mejoras visuales adicionales */
  .category-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -0.5rem;
    right: -0.5rem;
    bottom: 0;
    background: transparent;
    border-radius: 0.5rem;
    transition: background-color 0.2s ease;
    z-index: -1;
  }

  .category-button:hover::before {
    /* background-color: rgba(0, 0, 0, 0.02); */
  }

  .category-button.active::before {
    /* background-color: rgba(0, 0, 0, 0.03); */
  }
</style>